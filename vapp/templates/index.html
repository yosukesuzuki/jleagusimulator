{% extends "mainapp/base.html"%}
{% block title %}{% endblock %}
{% block description %}{% endblock %}
{% block content %}

<style>
#chart {
  height: 500px;
}
.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}
.node text {
  pointer-events: none;
  text-shadow: 0 1px 0 #fff;
}
.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}
.link:hover {
  stroke-opacity: .5;
}
</style>

<p id="chart"></p>

{% endblock %}
{%block scripts%}
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="/media/js/sankey.js"></script>
<script>
//parameters
var new_season_id = 19;
var gk_defence_ratio = 1.417;
var finisher_ratio = 0.8;
var from_high_school = 0.5;
var from_univ = 0.8;
var from_oversea = 2;

var margin = {top: 1, right: 1, bottom: 6, left: 1},
    width = 900 - margin.left - margin.right,
    height = 900 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),
    format = function(d) { return formatNumber(d); },
    color = d3.scale.category20();

True=true;
False=false;
trades={"directed": true, "graph": [], 
    "nodes": [{"name": "広島source", "id": 0},{"name": "広島target", "id": 1}], 
    "links": [{"source": 0, "target": 1, "value": 15.111111}], "multigraph": false};

$(document).ready(function() {
    var nodes = [];
    var links = [];
    $.getJSON('{{url_for('vapp/trade_data')}}', function (result) {
        var nodes_dic = {};
        $.each(result.nodes,function(i,val){
            if(typeof val.base_value !== 'undefined'){
                nodes_dic[val.name] = {'base_value':val.base_value,'id':val.id};
            }
            nodes.push(val);
        });
        //console.log(nodes_dic);
        $.each(result.links,function(i,val){
            if(val.player_type == 'GK'){
                val.value = (((val.goal_lost / val.game_count) - gk_defence_ratio)*val.game_count)*val.save_ratio*-0.01;
                links.push(val);
            }else{
                //todo j2選手の処理
                val.value = (val.goal_get * finisher_ratio) + val.assist * ( 1 - finisher_ratio);
                if(val.j_class == '高卒新人'){
                    val.value = from_high_school;
                }else if(val.j_class == '大卒新人'){
                    val.value = from_univ;
                }else if(val.j_class == '外国籍選手'){
                    val.value = from_oversea;
                }
                links.push(val);
            }
            if(typeof nodes_dic[val.old_team] !== 'undefined'){
                    nodes_dic[val.old_team].base_value = nodes_dic[val.old_team].base_value - val.value;
            }
        });
        //console.log(links);
        //console.log(nodes_dic);
        $.each(nodes_dic,function(i,val){
            //console.log(val);
            links.push({'source':val.id,'name':'残留','target':val.id+new_season_id,'value':val.base_value})
        });
        //console.log(links);
        nodes.sort(function(a,b){
		var a_id = a["id"];
		var b_id = b["id"];
		if( a_id < b_id ) return -1;
		if( a_id > b_id ) return 1;
		return 0;
        });
        trades.nodes = nodes;
        trades.links = links;
        console.log(trades);
        drawChart();
    });
});
//drawChart();

function drawChart(){ 
    var svg = d3.select("#chart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var sankey = d3.sankey()
        .nodeWidth(15)
        .nodePadding(10)
        .size([width, height]);
    var path = sankey.link();

    sankey
      .nodes(trades.nodes)
      .links(trades.links)
      .layout(32);

    var link = svg.append("g").selectAll(".link")
      .data(trades.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", path)
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .sort(function(a, b) { return b.dy - a.dy; });

    link.append("title")
      .text(function(d) { return d.source.name + " -> " + d.target.name + " " + format(d.value); });

    var node = svg.append("g").selectAll(".node")
      .data(trades.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
    .call(d3.behavior.drag()
      .origin(function(d) { return d; })
      .on("dragstart", function() { this.parentNode.appendChild(this); })
      .on("drag", dragmove));

    node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) { return d.color = color(d.name.replace(/ .*/, "")); })
      .style("stroke", function(d) { return d3.rgb(d.color).darker(2); })
    .append("title")
      .text(function(d) { return d.name + " " + format(d.value); });

    node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");
}

function dragmove(d) {
d3.select(this).attr("transform", "translate(" + d.x + "," + (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
sankey.relayout();
link.attr("d", path);
}
</script>

{% endblock %}
